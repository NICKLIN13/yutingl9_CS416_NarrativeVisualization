<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
        </script>
    <link href="css/global.css" rel="stylesheet">

    <title>CS416 Final Project</title>
    <style>
        .chart {
            margin: 20px;
        }

        .axis path,
        .axis line {
            fill: none;
            shape-rendering: crispEdges;
        }

        .line {
            fill: none;
            stroke: rgba(253, 119, 24, 0.912);
            stroke-width: 4px;
            stroke-dasharray: 1000;
            /* 初始的虛線長度 */
            stroke-dashoffset: 1000;
            /* 初始時的虛線偏移量 */
        }

        .dot {
            fill: rgb(39, 126, 198);
        }

        .axis-label {
            font-size: 12px;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 5px;
            font-size: 17px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 3px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>

<body style="padding-top: 70px;">
    <nav class="navbar navbar-light bg-light fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">CS416 - Final Project</a>
            <a class="navbar-brand" id="scene0" href="DV_Final_Scene1.html">Scene1</a>
            <a class="navbar-brand" id="scene1" href="DV_Final_Scene2.html">Scene2</a>
            <a class="navbar-brand" id="scene2" href="DV_Final_Scene3.html">Scene3</a>
            <a class="navbar-brand" id="scene3" href="DV_Final_Final.html">Final</a>

            <!-- <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="stem.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="second.html">Scene2</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="jumpoff.html">Scene3</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="final2.html">Final</a>
                    </li>
                </ul>
            </div> -->
        </div>
    </nav>

    <div class="container">
        <div class="header-with-border">
            <h1>Fertility Data Line Chart</h1>
        </div>
        <label for="country-select">Select Country:</label>
        <select id="country-select">
            <option value="">--Select a country-- (Default: World)</option>
        </select>
    </div>

    <div class="chart">
        <svg width="1360" height="500"></svg>
    </div>
    <div class="tooltip"></div>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>
        // 設置畫布大小和邊距
        const margin = { top: 20, right: 30, bottom: 30, left: 280 };
        const width = 1660 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        // 創建 SVG 畫布
        const svg = d3.select("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 創建 x 和 y 軸的比例尺
        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().domain([0, 8.0]).range([height, 0]); // 設置 y 軸範圍

        // 創建折線生成器
        const line = d3.line()
            .x(d => x(d.year))
            .y(d => y(d.fertility));

        // 創建 tooltip
        const tooltip = d3.select(".tooltip");

        // 讀取 CSV 數據
        d3.csv("/CSV_data/世界總生育人數.csv").then(data => {
            // 格式化數據
            const years = d3.range(1980, 2023);
            const formattedData = data.map(d => ({
                country: d.Country_Name,
                code: d.Country_Code,
                values: years.map(year => ({
                    year: new Date(year, 0, 1),
                    fertility: +d[year]
                }))
            }));

            // 創建國家選擇下拉選單
            const select = d3.select("#country-select");
            select
                .selectAll("option")
                .data(formattedData)
                .enter()
                .append("option")
                .attr("value", d => d.code)
                .text(d => d.country);

            // 繪製折線圖的函數
            function drawChart(countryCode) {
                const countryData = formattedData.find(d => d.code === countryCode);

                if (!countryData) return;

                // 設置 x 軸範圍
                x.domain(d3.extent(countryData.values, d => d.year));

                // 清除以前的圖表
                svg.selectAll(".line").remove();
                svg.selectAll(".x-axis").remove();
                svg.selectAll(".y-axis").remove();
                svg.selectAll(".dot").remove(); // 清除舊的點

                // 繪製 x 和 y 軸
                svg.append("g")
                    .attr("class", "x-axis axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).ticks(d3.timeYear.every(1)))
                    .append("text")
                    .attr("class", "axis-label")
                    .attr("x", width)
                    .attr("y", -10)
                    .style("text-anchor", "end")
                    .text("Year");

                svg.append("g")
                    .attr("class", "y-axis axis")
                    .call(d3.axisLeft(y))
                    .append("text")
                    .attr("class", "axis-label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("Fertility");

                // 繪製折線
                const path = svg.append("path")
                    .datum(countryData.values)
                    .attr("class", "line")
                    .attr("d", line)
                    .style("stroke-dasharray", function () {
                        const length = this.getTotalLength();
                        return `${length} ${length}`;
                    })
                    .style("stroke-dashoffset", function () {
                        return this.getTotalLength();
                    });

                // 添加動畫效果
                path.transition()
                    .duration(2000)  // 動畫持續時間（毫秒）
                    .style("stroke-dashoffset", 0);  // 使折線逐漸顯現

                // 添加點和 tooltip 功能
                svg.selectAll(".dot")
                    .data(countryData.values)
                    .enter().append("circle")
                    .attr("class", "dot")
                    .attr("r", 4)
                    .attr("cx", d => x(d.year))
                    .attr("cy", d => y(d.fertility))
                    .on("mouseover", (event, d) => {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(`Year: ${d.year.getFullYear()}<br>Fertility: ${d.fertility}`)
                            .style("left", `${event.pageX + 5}px`)
                            .style("top", `${event.pageY - 28}px`);
                    })
                    .on("mouseout", () => {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            }

            // 初始化圖表顯示
            drawChart(formattedData[248].code);

            // 更新圖表根據選擇的國家
            d3.select("#country-select").on("change", function () {
                drawChart(this.value);
            });
        }).catch(error => {
            console.error("Error loading or processing data:", error);
        });
    </script>

    <div class="container mt-4">
        <div class="accordion" id="accordionExample">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        About the Visualization, Home Page
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                    data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <div class="panel">
                            <h3>Visualization Narrative</h3>
                            <p class="lead">The project follows the <strong>Martini Glass</strong> narrative
                                visualization
                                structure.
                                The <strong>Home page</strong> represents the base of the visualization structure. The
                                user
                                is being exposed
                                to the author driven content and will be led through two additional scenes representing
                                stem. The Scene3
                                page is the "jumping off point" and leads user to the final page.
                                Final page contains reader driven content and it allows users to draw their own
                                conclusions.
                            </p>
                            <p class="lead">
                                Each page/scence contains <strong>About the Visualization </strong> section at the
                                bottom of
                                the page.
                                User can learn more about the user interface events, triggers, annotations and paramters
                                for
                                that particular page.
                            </p>
                            <h3>User Interface Events</h3>
                            <p class="lead">The menu items in the navigation bar and the Prev, Next button
                                at the bottom of this page enable the User Interface events.
                                User interacts by clicking on the button or menu items to navigate to various part of
                                this
                                story.
                                The mouse hover is another user interface event. The hover event allows proper
                                positioning
                                of the tooltip.
                                As mouse moves from one bar to another, changes in X and Y position causes opacity to
                                revert back to its original state in the previous bar and change in the new bar.
                            </p>
                            <h3>Annotations</h3>
                            <p class="lead">The annotation is represented by the legend on the top-right of the chart
                                and a
                                tooltip when mouse is hovered over different bars in the chart.
                                The legend and labels along the X and Y axis provides additional annotations for the
                                chart.
                            </p>
                            <h3>Triggers</h3>
                            <p class="lead">The mouse click acts as a trigger event for navigation.
                                The mouse hover (mouseover) event is a trigger for the tooltip in the bar chart.
                                The highlighted items in the navigation bar and colored buttons with
                                icons provide visual clues about the user actions triggers to the user.
                            </p>
                            <p class="lead">
                                User can expand the <strong>About the Visualization </strong> section by clicking on the
                                +
                                icon. Once the section is expanded,
                                the + icon changes to - icon. User can click the - icon to collapse the section.
                            </p>
                            <h3>Parameters</h3>
                            <p class="lead">This section is hyper linked to the next section. The name of the target
                                section
                                is passed
                                as an input paramter to the buttons and items in the navigation bar.
                            </p>

                            <p class="lead">The charts in this and next two scenes are rendered through Vega library.
                                Vega
                                is a declarative language and entire chart including data is defined as a JSON object.
                                The data for the chart is passed as a JSON object to
                                Vega API function for rendering axis,bars and tooltips for the chart. The JSON object is
                                stored seperately in the <strong>overallpoverty.json</strong>
                                file under data folder.
                            </p>
                            <strong>Note </strong>This website is compatible with Chrome, Safari and Firefox browsers.
                            This
                            site was not tested on Internet Explorer.
                            If you are on Windows, please use a Chrome or Firefox browser.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer text-center">
        <div class="container">
            <p class="text-muted"></p>
            <strong>Author <a href="https://www.linkedin.com/in/yuting-nick-lin/" target="_blank">YuTing
                    Lin</a></strong>
            <br>
            <p>©️All rights reserved</p>
        </div>
    </footer>
</body>

</html>